    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        // PRODUCTION-READY SECURITY RULES
        // These rules enforce proper access control:
        // - Users can only access their own private data (chats, AI profiles, etc.)
        // - Social features (posts, feed) allow read access but restrict writes to owners
        // - All rules validate userId matches authenticated user

        match /workouts/{workoutId} {
          allow read: if request.auth != null &&
            (resource.data.userId == request.auth.uid || resource.data.isPublic);
          allow create: if request.auth != null &&
            request.resource.data.userId == request.auth.uid;
          allow update, delete: if request.auth != null &&
            resource.data.userId == request.auth.uid;
        }

        match /user_workout_stats/{userId} {
          allow read: if request.auth != null;
          allow write: if request.auth != null &&
            request.auth.uid == userId;
        }

        // Allow authenticated users to read and write their own user profiles
        match /users/{userId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }

        // Enhanced user profiles with social features - Fixed permissions
        match /user_profiles/{userId} {
          // Allow read if user is authenticated AND (profile is public OR user owns it)
          allow read: if request.auth != null &&
            (resource.data.isPublic == true || request.auth.uid == userId);

          // Allow create only by the owner with valid data
          allow create: if request.auth != null &&
            request.auth.uid == userId &&
            request.resource.data.uid == userId;

          // Allow full update by the owner
          allow update: if request.auth != null &&
            request.auth.uid == userId &&
            request.resource.data.uid == userId;

          // Allow limited update for follow/unfollow (only follower counts)
          allow update: if request.auth != null &&
            request.auth.uid != userId &&
            onlyFollowerCountsChanged();

          // Allow delete only by the owner
          allow delete: if request.auth != null && request.auth.uid == userId;
        }

        // Helper function to check if only follower/following counts changed
        function onlyFollowerCountsChanged() {
          let affectedKeys = request.resource.data.diff(resource.data).affectedKeys();
          return affectedKeys.hasOnly(['followersCount', 'followingCount', 'updatedAt']);
        }

        // AI personality profiles - private to user (PRODUCTION - SECURE)
        match /ai_personality_profiles/{userId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }

        // User context for AI - private to user
        match /user_context/{userId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }

        // Social following relationships - Fixed permissions
        match /user_following/{followId} {
          // Allow read if user is checking their own follow relationships
          // followId format is: {followerId}_{followingId}
          allow read: if request.auth != null &&
            followId.split('_')[0] == request.auth.uid;

          // Allow create if user is the follower and data is valid
          allow create: if request.auth != null &&
            request.auth.uid == request.resource.data.followerId &&
            request.resource.data.followerId != request.resource.data.followingId;

          // Allow delete if user is the follower (unfollowing)
          allow delete: if request.auth != null &&
            followId.split('_')[0] == request.auth.uid;
        }

        // Workout posts for social feed (PRODUCTION - SECURE)
        match /workout_posts/{postId} {
          allow read: if request.auth != null;
          allow create: if request.auth != null &&
            request.resource.data.userId == request.auth.uid;
          allow update, delete: if request.auth != null &&
            resource.data.userId == request.auth.uid;
        }

        // Feed posts
        match /feed_posts/{postId} {
          allow read: if request.auth != null;
          allow create: if request.auth != null &&
            request.resource.data.userId == request.auth.uid;
          allow update, delete: if request.auth != null &&
            resource.data.userId == request.auth.uid;
        }

        // Workout interactions (likes, comments, etc.) (PRODUCTION - SECURE)
        match /workout_interactions/{interactionId} {
          allow read: if request.auth != null;
          allow create: if request.auth != null &&
            request.resource.data.userId == request.auth.uid;
          allow update, delete: if request.auth != null &&
            resource.data.userId == request.auth.uid;
        }

        // AI recommendations - private to user
        match /ai_recommendations/{recommendationId} {
          allow read, write: if request.auth != null &&
            resource.data.userId == request.auth.uid;
        }

        // Chats collection - restricted to owner (PRODUCTION - SECURE)
        match /chats/{chatId} {
          allow read, write: if request.auth != null &&
            resource.data.userId == request.auth.uid;
          allow create: if request.auth != null &&
            request.resource.data.userId == request.auth.uid;
        }

        // Chat sessions (PRODUCTION - SECURE)
        match /chat_sessions/{sessionId} {
          allow read, write: if request.auth != null &&
            resource.data.userId == request.auth.uid;
          allow create: if request.auth != null &&
            request.resource.data.userId == request.auth.uid;
        }

        // Chat messages (PRODUCTION - SECURE)
        match /chat_messages/{messageId} {
          allow read, write: if request.auth != null &&
            resource.data.userId == request.auth.uid;
          allow create: if request.auth != null &&
            request.resource.data.userId == request.auth.uid;
        }

        // Onboarding contexts - private to user
        match /onboarding_contexts/{userId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }

        // Profile pictures - private to user
        match /profile_pictures/{pictureId} {
          allow read, write: if request.auth != null &&
            resource.data.userId == request.auth.uid;
          allow create: if request.auth != null &&
            request.resource.data.userId == request.auth.uid;
        }

        // User settings - private to user
        match /user_settings/{userId} {
          allow read, write: if request.auth != null && request.auth.uid == userId;
        }

        // User sessions - private to user
        match /user_sessions/{sessionId} {
          allow read, write: if request.auth != null &&
            resource.data.userId == request.auth.uid;
          allow create: if request.auth != null &&
            request.resource.data.userId == request.auth.uid;
        }

        // Conversation states for agentic AI - private to user
        match /conversation_states/{sessionId} {
          allow read, write: if request.auth != null &&
            resource.data.userId == request.auth.uid;
          allow create: if request.auth != null &&
            request.resource.data.userId == request.auth.uid;
        }
      }
    }